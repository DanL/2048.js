<!DOCTYPE html>
<html lang="en">
<head>
  <title>2048</title>
  <meta charset="utf-8" />
  <script type="text/javascript" src="underscore-1.6.0.min.js"></script>
  <script type="text/javascript" src="board.js"></script>
  <script type="text/javascript" src="game.js"></script>

  <script type="text/javascript" src="jquery-2.1.0.min.js"></script>

  <script type="text/javascript">
    var game, board_size = 5;

    function generate_html(board) {
      return _.flatten(board).map(function(number) {
        if(number === 0) number = '&nbsp;';
        return '<div>' + number + '</div>';
      });
    }

    function update_page() {
      $('#board').html(generate_html(game.get_board().board));
    }

    // this must be called within document#ready
    function new_game() {
      board_size = (function() {
        var size = parseInt($('[name="board_size"]').val());
        if(size > 1) {
          return size;
        }
        else {
          return 5;
        }
      })();

      game = new Game(board_size);
      game.start();

      $('#board').css({
        width: (50 * board_size) + 'px',
        height: (50 * board_size) + 'px'
      });

      update_page();
    }

    $(document).ready(function() {
      $(document).on('keyup', function(e) {
        // prevent this from running on invalid keys
        if(e.which < 37 || e.which > 40) return;

        switch(e.which) {
          case 37:
            game.move('left');
            break;
          case 38:
            game.move('up');
            break;
          case 39:
            game.move('right');
            break;
          case 40:
            game.move('down');
            break;
        }

        // TODO: fix this logic
        if(!game.has_possible_move()) {
          alert('Sorry, you lost!');
        }
        else {
          // update regardless of whether the board has changed
          update_page();
        }
      });

      new_game();

      $('[name="new"]').click(function() {
        new_game();
      });
    });
  </script>

  <style type="text/css">
    * { color: #000; font-family: monospace; font-size: 12pt; }
    body { background-color: #fff; cursor: default;}
    #board { margin: 50px; }
      #board ::selection { background-color: transparent; }
      #board div {
        background-color: #eee;
        width: 40px; height: 40px; margin: 5px; display: inline-block;
        text-align: center; padding-top: 11px; box-sizing: border-box;
      }
  </style>
</head>
<body>
  <div>
    <label>
      Board Size:
      <input type="number" name="board_size" min="2" max="12" value="5" />
    </label>
    <input type="button" name="new" value="New Game" />
  </div>
  <div id="board"></div>
</body>
</html>
